# Notas internas – Tienda3D (solo para asistente)

Instantánea del proyecto para acelerar comprensión y navegación técnica. (Actualizado: incluye auth admin JWT y endpoints revisados.)

## Stack y arquitectura
- Go 1.22 (módulo: github.com/phenrril/tienda3d)
- Arquitectura hexagonal: domain (entidades/puertos) · usecase (lógica) · adapters (http, repos, payments, storage) · app (wiring)
- SSR con html/template (templates embebidos en internal/views)
- Persistencia: GORM + Postgres
- Pagos: MercadoPago (preferencias de checkout; sandbox/prod según token y APP_ENV)
- Storage local de archivos en `uploads/` (imágenes y modelos)
- OAuth Google opcional; notificaciones Telegram y/o email (SMTP) opcionales
- Autenticación Admin JWT (API key + email permitido) para endpoints de gestión y listado de órdenes

## Entradas principales
- cmd/tienda3d/main.go: carga .env, init logger, abre DB, NewApp, auto-migraciones/backfill, crea http.Server con handler de app, bind en PORT (fallback 8081–8090 si ocupado), shutdown gracioso.
- internal/app/app.go: construye repos (products, orders, uploaded models, customers), storage local, gateway MP, OAuth config (si vars), parse templates (views.FS). Devuelve http.Handler con httpserver.New().

## HTTP (internal/adapters/httpserver)
- Middlewares: RequestID, Logging, Recovery, Gzip, RateLimit(60 rpm para /api/*)
- Rutas estáticas: /public/* (public/), /uploads/* (uploads/)
- SSR: `/`, `/products`, `/product/{slug}`, `/quote/{id}`, `/checkout`, `/pay/{orderID}`
- Cart (cookie firmada): /cart (GET/POST), /cart/update, /cart/remove, /cart/checkout
- API JSON protegida por JWT admin (Bearer):
  - POST /api/products (crear)
  - GET /api/products (listar)
  - GET /api/products/{slug} (detalle por slug)
  - DELETE /api/products/{slug} (borrado completo + archivos)
  - POST /api/products/delete (borrado masivo simple)
  - POST /api/products/upload (multipart: producto + múltiples imágenes)
  - GET /admin/orders (listado paginado de órdenes)
- API pública:
  - POST /api/quote (cotizar UploadedModel)
  - POST /api/checkout (orden desde quote)
  - POST /webhooks/mp (webhook MercadoPago)
- Auth Google: /auth/google/login · /auth/google/callback · /logout
- Admin login: POST /admin/login (header X-Admin-Key, opcional email) -> JWT expira ~30m.

## Dominio (internal/domain)
- Entidades: Product, Variant, Image, Order (+OrderItem), Quote, UploadedModel, Customer, Page
- Puertos: ProductRepo, OrderRepo, QuoteRepo, UploadedModelRepo, PageRepo, CustomerRepo, PaymentGateway, FileStorage, PricingService, QuoteService, Clock

## Repos Postgres (internal/adapters/repo/postgres)
- ProductRepo: Save · FindBySlug · List · AddImages · DeleteBySlug/Full (colecta rutas de imágenes para borrado físico)
- OrderRepo: Save (Create/update) · FindByID · FindByPreferenceID · UpdateStatus · List
- UploadedModelRepo: Save · FindByID
- CustomerRepo: FindByEmail · Save
- NOTA (gap): No hay implementación de QuoteRepo (pero interfaz existe).

## Casos de uso (internal/usecase)
- ProductUC: List/GetBySlug/Create/AddImages/DeleteBySlug/DeleteFullBySlug
- OrderUC: CreateFromQuote(quote->order), UpdateStatus
- PaymentUC: CreatePreference (delegado al gateway)
- QuoteUC: CreateFromModel/Reprice (requiere repos Models + Quotes, PricingService y Clock). Wiring actual no inicializa QuoteUC ni QuoteRepo (gap operativo para /api/quote si se invoca).

## Pricing (internal/adapters/pricing/simple)
- Fórmula simple: precio por volumen + tiempo + ajuste por layer + factor por infill + margen; retorna breakdown.

## Pagos (internal/adapters/payments/mercadopago)
- CreatePreference: items (incluye envío si corresponde), back_urls `/pay/{orderID}`, notification_url `/webhooks/mp`, external_reference firmado (HMAC con SECRET_KEY). Selección sandbox/prod según token y APP_ENV.
- PaymentInfo: GET /v1/payments/{id}; retorna (status, external_reference)
- VerifyExternalRef: valida external_reference (orderID|sig)
- Webhook: consulta PaymentInfo, valida ref, actualiza Order.Status/MPStatus; dispara notificaciones.

## Storage (internal/adapters/storage/localfs)
- SaveImage/SaveModel: `uploads/{images|models}/<nsec>-<filename>`; rutas servidas por /uploads/*.

## Templates (internal/views)
- Embebidos via go:embed (*.html, admin/*.html)
- Admin carpeta contiene: auth.html, dashboard.html, orders.html, products.html, sales.html
- GAP: handler usa `admin_orders.html` pero existe `orders.html` (mismatch de nombre) -> error potencial.

## Docker/DevOps
- Makefile: targets dev/build/test/run, docker-build, docker-run
- Dockerfile: multi-stage; revisar COPY context (posible inconsistencia con build root)
- docker-compose.yml: incluye db (Postgres), app, caddy; variables via .env; mappea uploads/ y public/.

## Seguridad
- JWT admin firmado con `JWT_ADMIN_SECRET` (fallback SECRET_KEY). Expira ~30m.
- ADMIN_API_KEY + ADMIN_ALLOWED_EMAILS obligatorios para proteger creación/borrado productos.
- Cookies de carrito firmadas (no cifradas) con SESSION_KEY.

## Hallazgos / Riesgos pendientes
1. Quote flow incompleto (faltan wiring + repositorio real) -> endpoints de quote pueden fallar.
2. Mismatch template `admin_orders.html` vs archivo existente `orders.html`.
3. Docker build context/COPY podrían romper build en producción.
4. Costos de envío hardcodeados (`provinceCosts`).

## Quick start (local)
```
go run ./cmd/tienda3d
```
Variables claves: PORT, APP_ENV, MP_ACCESS_TOKEN (TEST-...), PUBLIC_BASE_URL, BASE_URL, SESSION_KEY, SECRET_KEY, ADMIN_API_KEY, ADMIN_ALLOWED_EMAILS.

## Endpoints resumen
- Admin login: POST /admin/login (X-Admin-Key)
- Admin/orders: GET /admin/orders (Bearer)
- Productos (Bearer): POST/GET /api/products, GET /api/products/{slug}, DELETE /api/products/{slug}, POST /api/products/delete, POST /api/products/upload
- Públicos: POST /api/quote, POST /api/checkout, POST /webhooks/mp, SSR páginas básicas.

-- Fin --
