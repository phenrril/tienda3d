{{define "product.html"}}
{{template "layout_start" .}}
<article class="product-detail">
  <div class="pd-media">
    {{if .Product.Images}}
      <div class="pd-carousel" id="pdCarousel" data-count="{{len .Product.Images}}">
        <div class="pd-slides">
          {{range $i,$img := .Product.Images}}
            <img class="pd-slide {{if eq $i 0}}active{{end}}" src="{{$img.URL}}" alt="{{if $img.Alt}}{{$img.Alt}}{{else}}{{$.Product.Name}}{{end}}" data-index="{{$i}}" loading="lazy" />
          {{end}}
        </div>
        <button type="button" class="pd-nav prev" aria-label="Anterior">‹</button>
        <button type="button" class="pd-nav next" aria-label="Siguiente">›</button>
        <div class="pd-thumbs">
          {{range $i,$img := .Product.Images}}
            <button type="button" class="pd-thumb {{if eq $i 0}}active{{end}}" data-index="{{$i}}">
              <img src="{{$img.URL}}" alt="{{if $img.Alt}}{{$img.Alt}}{{else}}{{$.Product.Name}}{{end}} miniatura" loading="lazy" />
            </button>
          {{end}}
        </div>
      </div>
    {{else}}
      <div class="pd-carousel empty" data-count="0"><div class="pd-slides placeholder">SIN IMAGEN</div></div>
    {{end}}
  </div>
  <div class="pd-info">
    <h1 class="pd-title">{{.Product.Name}}</h1>
    <div class="pd-price">${{printf "%.2f" .Product.BasePrice}}</div>
    <div class="pd-share" id="pdShareBar" aria-label="Compartir producto">
      <div class="pd-share-label">Compartir</div>
      <div class="pd-share-row">
        <button type="button" class="share-btn sb-whatsapp" data-share="whatsapp" title="Compartir en WhatsApp" aria-label="Compartir en WhatsApp">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M12.04 2c-5.52 0-10 4.46-10 9.97 0 1.76.46 3.48 1.34 5.01L2 22l5.2-1.36a9.96 9.96 0 0 0 4.84 1.23h.01c5.52 0 10-4.46 10-9.97 0-2.67-1.05-5.18-2.95-7.06A9.93 9.93 0 0 0 12.04 2Zm5.83 14.28c-.25.7-1.46 1.33-2.02 1.39-.52.05-1.19.07-1.92-.12-.44-.11-1-.33-1.72-.65-3.03-1.31-5-4.37-5.15-4.58-.15-.21-1.23-1.63-1.23-3.11 0-1.48.78-2.2 1.05-2.5.27-.3.6-.37.8-.37.2 0 .4 0 .57.01.18.01.43-.07.68.52.25.59.85 2.05.92 2.2.07.15.12.33.02.54-.1.21-.15.33-.3.51-.15.18-.31.4-.44.54-.15.15-.3.32-.13.63.18.3.8 1.32 1.72 2.14 1.18 1.05 2.17 1.38 2.49 1.53.32.15.5.13.68-.07.18-.2.78-.9.98-1.21.2-.3.4-.25.68-.15.27.09 1.73.81 2.03.95.3.15.5.22.57.34.07.12.07.72-.18 1.42Z"/></svg>
          <span>WhatsApp</span>
        </button>
        <button type="button" class="share-btn sb-instagram" data-share="instagram" title="Compartir en Instagram" aria-label="Compartir en Instagram">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M7.75 2h8.5A5.75 5.75 0 0 1 22 7.75v8.5A5.75 5.75 0 0 1 16.25 22h-8.5A5.75 5.75 0 0 1 2 16.25v-8.5A5.75 5.75 0 0 1 7.75 2Zm0 1.5A4.25 4.25 0 0 0 3.5 7.75v8.5A4.25 4.25 0 0 0 7.75 20.5h8.5a4.25 4.25 0 0 0 4.25-4.25v-8.5A4.25 4.25 0 0 0 16.25 3.5h-8.5ZM12 7.25a4.75 4.75 0 1 1 0 9.5 4.75 4.75 0 0 1 0-9.5Zm0 1.5a3.25 3.25 0 1 0 0 6.5 3.25 3.25 0 0 0 0-6.5Zm5.25-.88a1.12 1.12 0 1 1 0 2.25 1.12 1.12 0 0 1 0-2.25Z"/></svg>
          <span>Instagram</span>
        </button>
        <button type="button" class="share-btn sb-x" data-share="x" title="Compartir en X" aria-label="Compartir en X">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M3 3h4.3L14 11.1 19.7 3H21l-6.2 8.9L21 21h-4.3L10 12.9 4.3 21H3l6.2-8.9L3 3Z"/></svg>
          <span>X</span>
        </button>
        <button type="button" class="share-btn sb-threads" data-share="threads" title="Compartir en Threads" aria-label="Compartir en Threads">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M12.01 2c5.52 0 9.99 4.47 9.99 9.99S17.53 22 12.01 22 2.02 17.53 2.02 11.99 6.49 2 12.01 2Zm3.65 10.18c.02-.2.03-.41.03-.62 0-3.16-2.17-5.26-5.66-5.26-1.52 0-2.88.46-3.81 1.12l.86 1.55c.74-.5 1.76-.86 2.89-.86 2.06 0 3.37 1.15 3.56 3.03-1.02-.47-2.21-.63-3.28-.63-2.63 0-4.56 1.3-4.56 3.58 0 2.13 1.69 3.61 4.06 3.61 1.41 0 2.56-.48 3.32-1.24.51.83 1.38 1.32 2.49 1.32h1.47v-1.68h-1.2c-.63 0-1.02-.3-1.19-.91.5-.6.82-1.36.92-2.01ZM10.3 15.9c-1.34 0-2.24-.7-2.24-1.86 0-1.2 1.02-1.98 2.77-1.98.98 0 1.97.2 2.83.66-.25 1.86-1.56 3.18-3.36 3.18Z"/></svg>
          <span>Threads</span>
        </button>
        <button type="button" class="share-btn sb-copy" data-share="copy" title="Copiar enlace" aria-label="Copiar enlace">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M8 3a3 3 0 0 1 3-3h10a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3h-2v-2h2a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1H11a1 1 0 0 0-1 1v2H8V3Zm-5 5a3 3 0 0 1 3-3h10a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3V8Zm3-1a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V8a1 1 0 0 0-1-1H6Z"/></svg>
          <span>Copiar</span>
        </button>
      </div>
      <span class="share-msg" id="shareMsg" role="status" aria-live="polite" style="display:none"></span>
    </div>
    <p class="pd-desc"><strong>Descripción:</strong> {{.Product.ShortDesc}}</p>
    <div class="pd-cat"><strong>Categoría:</strong> {{.Product.Category}}</div>
    <div class="pd-size"><strong>Tamaño aprox:</strong> {{printf "%.0f" .Product.WidthMM}}x{{printf "%.0f" .Product.HeightMM}}x{{printf "%.0f" .Product.DepthMM}}mm</div>
    <div class="pd-note" role="note">
      <strong>Importante:</strong> el tiempo de impresión depende del tamaño de cada pieza. Para cualquier consulta, escribinos por <a href="https://wa.me/5493416219815" target="_blank" rel="noopener">WhatsApp</a>.
    </div>
    <form method="post" action="/cart" class="pd-form">
      <input type="hidden" name="slug" value="{{.Product.Slug}}" />
      <div class="color-picker">
        <div class="cp-label">Color <span id="colorPreview" class="color-dot" style="vertical-align:middle;margin-left:8px"></span></div>
        <div class="cp-swatches" id="cpSwatches">
          {{range $i,$c := .Colors}}
            <button type="button" class="swatch {{if eq $i 0}}active{{end}}" data-color="{{$c}}" style="--c: {{colorhex $c}}" aria-label="Seleccionar color {{$c}}" role="radio" aria-checked="{{if eq $i 0}}true{{else}}false{{end}}"></button>
          {{end}}
          <button type="button" class="swatch swatch-other" data-color="" aria-label="Seleccionar otro color" title="Otro" role="radio" aria-checked="false"></button>
        </div>
        <div class="custom-color-row" id="customColorRow" style="display:none">
          <input type="text" id="customColorInput" placeholder="Escribe el color (ej: rojo o #ff0000)" autocomplete="off" />
        </div>
        <input type="hidden" name="color" id="colorInput" value="{{.DefaultColor}}" aria-describedby="color-desc" />
        <p id="color-desc" class="sr-only">Selecciona el color del producto</p>
      </div>
      <div class="pd-actions">
        <button class="btn-primary" type="submit">Agregar al carrito</button>
        <a href="/cart" class="btn-secondary">Ver carrito</a>
        <span id="addedMsg" class="added-msg" {{if ne .Added 1}}hidden{{end}}>{{if eq .Added 1}}Agregado!{{end}}</span>
      </div>
    </form>
    
  </div>
</article>
<script>
(function(){
  const sw=[...document.querySelectorAll('.swatch')];
  const inp=document.getElementById('colorInput');
  const otherBtn=document.querySelector('.swatch-other');
  const customRow=document.getElementById('customColorRow');
  const customInput=document.getElementById('customColorInput');
  const defaultColor=inp.value;
  const preview=document.getElementById('colorPreview');
  if(preview){ preview.style.background = defaultColor; }
  sw.forEach(b=>b.addEventListener('click',()=>{
    sw.forEach(x=>{ x.classList.remove('active'); x.setAttribute('aria-checked','false'); });
    b.classList.add('active');
    b.setAttribute('aria-checked','true');
    if(b.classList.contains('swatch-other')){
      customRow.style.display='';
      customInput.focus();
      inp.value=customInput.value.trim();
    }else{
      customRow.style.display='none';
      inp.value=b.dataset.color;
    }
    if(preview){ preview.style.background = inp.value || defaultColor; }
  }));
  if(customInput){
    customInput.addEventListener('input',()=>{
      const val=customInput.value.trim();
      inp.value=val;
      if(otherBtn && val){ otherBtn.style.setProperty('--c', val); }
      if(preview){ preview.style.background = val || defaultColor; }
    });
  }
  const form=inp.closest('form');
  if(form){ form.addEventListener('submit',()=>{ if(inp.value.trim()===''){ inp.value=defaultColor; } }); }
  const root=document.getElementById('pdCarousel');
  if(root){
    const slides=[...root.querySelectorAll('.pd-slide')];
    const thumbs=[...root.querySelectorAll('.pd-thumb')];
    const total=slides.length; if(total>0){
      let idx=0; let auto=null; const AUTOPLAY=5000;
      const prevBtn=root.querySelector('.pd-nav.prev');
      const nextBtn=root.querySelector('.pd-nav.next');
      if(total===1){ prevBtn.style.display='none'; nextBtn.style.display='none'; const tb=root.querySelector('.pd-thumbs'); if(tb) tb.style.display='none'; return; }
      function show(n){slides[idx].classList.remove('active');thumbs[idx].classList.remove('active');idx=(n+total)%total;slides[idx].classList.add('active');thumbs[idx].classList.add('active');}
      function next(){show(idx+1);} function prev(){show(idx-1);} function start(){auto=setInterval(next,AUTOPLAY);} function restart(){clearInterval(auto);start();}
      // Delegación de eventos para robustez
      root.addEventListener('click', (e)=>{
        const t=e.target.closest('.pd-thumb');
        if(t){ const i=parseInt(t.getAttribute('data-index')||'-1'); if(!isNaN(i) && i>=0 && i<total){ show(i); restart(); } return; }
        if(e.target.closest('.pd-nav.prev')){ prev(); restart(); return; }
        if(e.target.closest('.pd-nav.next')){ next(); restart(); return; }
      });
      // Swipe support for mobile
      let startX = 0;
      let isSwiping = false;
      root.addEventListener('touchstart', e => {
        startX = e.touches[0].clientX;
        isSwiping = true;
      }, { passive: true });
      root.addEventListener('touchmove', e => {
        if (!isSwiping) return;
        const currentX = e.touches[0].clientX;
        const deltaX = currentX - startX;
        if (Math.abs(deltaX) > 10) {
          e.preventDefault(); // Prevent scroll if swiping horizontally
        }
      }, { passive: false });
      root.addEventListener('touchend', e => {
        if (!isSwiping) return;
        isSwiping = false;
        const endX = e.changedTouches[0].clientX;
        const deltaX = endX - startX;
        if (Math.abs(deltaX) > 50) {
          if (deltaX > 0) {
            prev();
          } else {
            next();
          }
          restart();
        }
      }, { passive: true });

      let sx=null; root.addEventListener('pointerdown',e=>{sx=e.clientX;}); root.addEventListener('pointerup',e=>{ if(sx==null) return; const dx=e.clientX-sx; if(Math.abs(dx)>40){ dx<0?next():prev(); restart(); } sx=null; });
      root.addEventListener('keydown',e=>{ if(e.key==='ArrowRight'){next();restart();} else if(e.key==='ArrowLeft'){prev();restart();} });
      root.tabIndex=0; start();
    }
  }
})();
// Share buttons logic movido a /public/assets/app.js por CSP
// Nuevo: interceptar submit para añadir al carrito sin recargar
(function(){
  const form=document.querySelector('.pd-form'); if(!form) return;
  const addedMsg=document.getElementById('addedMsg');
  form.addEventListener('submit',function(e){
    e.preventDefault();
    const submitBtn=form.querySelector('button[type=submit]');
    if(submitBtn) submitBtn.disabled=true;
    const fd=new FormData(form);
    // Forzar el valor de color a lo actualmente seleccionado
    try{
      const cur=(inp && typeof inp.value==='string')?inp.value.trim():'';
      const finalCol=cur||defaultColor||'';
      if(fd.has('color')) fd.set('color', finalCol); else fd.append('color', finalCol);
    }catch{}
    const usp=new URLSearchParams();
    fd.forEach((v,k)=>{ if(typeof v==='string') usp.append(k,v); });
    fetch('/cart',{
      method:'POST',
      headers:{
        'Accept':'application/json',
        'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8',
        'X-Requested-With':'fetch'
      },
      body:usp.toString(),
      redirect:'manual'
    }).then(async res=>{
      if(res.ok){
        let itemsCount=null; try{ const j=await res.json(); itemsCount=j.items; }catch{}
        if(addedMsg){
          addedMsg.hidden=false;
            addedMsg.textContent='Agregado'+(itemsCount!=null?` (total ${itemsCount})`:'')+'!';
          addedMsg.classList.add('show');
          setTimeout(()=>{addedMsg.classList.remove('show');},2500);
        }
      }else if(res.status===302){
        if(addedMsg){ addedMsg.hidden=false; addedMsg.textContent='Agregado!'; addedMsg.classList.add('show'); setTimeout(()=>addedMsg.classList.remove('show'),2500); }
      }else{
        throw new Error('status '+res.status);
      }
    }).catch(()=>{
      if(addedMsg){
        addedMsg.hidden=false;
        addedMsg.textContent='Error';
        addedMsg.classList.add('error','show');
      }
    }).finally(()=>{ if(submitBtn) submitBtn.disabled=false; });
  });
})();
</script>
{{template "layout_end" .}}
{{end}}
