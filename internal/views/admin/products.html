{{define "admin_products.html"}}
{{template "layout_start" .}}
<h1>Productos</h1>
<nav class="admin-nav"><a href="/admin/products" class="active">Productos</a> | <a href="/admin/orders">√ìrdenes</a> | <a href="/admin/sales">Ventas</a> | <a href="/admin/costs">Calculadora</a> | <a href="/admin/logout">Salir</a></nav>
<section class="grid" style="margin-top:1rem;grid-template-columns:420px 1fr;gap:2rem;align-items:start">
  <div class="admin-card" style="padding:18px 20px 24px">
    <div class="row between center" style="margin-bottom:6px">
      <h2 style="margin:0;font-size:18px">Gesti√≥n de producto</h2>
      <span id="formMode" class="mode-badge create">Creaci√≥n</span>
    </div>
    <form id="prodForm" class="form-card" autocomplete="off" data-token="{{.AdminToken}}">
      <input type="hidden" name="slug" id="pfSlug" />
      <label>Nombre<input type="text" name="name" id="pfName" required placeholder="Nombre visible" /></label>
      <label>Categor√≠a<input type="text" name="category" id="pfCategory" placeholder="(opcional)" /></label>
      <label>Descripci√≥n corta<textarea name="short_desc" id="pfShort" placeholder="Resumen / marketing"></textarea></label>
      <div class="row" style="gap:.5rem">
        <label style="flex:1">Ancho (mm)<input type="number" step="0.1" min="0" id="pfWidth" placeholder="0" /></label>
        <label style="flex:1">Alto (mm)<input type="number" step="0.1" min="0" id="pfHeight" placeholder="0" /></label>
        <label style="flex:1">Profundidad (mm)<input type="number" step="0.1" min="0" id="pfDepth" placeholder="0" /></label>
      </div>
      <label>Precio base<input type="number" step="0.01" min="0" name="base_price" id="pfPrice" required placeholder="0.00" /></label>
      <label class="row center" style="gap:.5rem"><input type="checkbox" name="ready_to_ship" id="pfReady" /> Listo para env√≠o</label>
      <div class="uploader-block">
        <label style="display:flex;flex-direction:column;gap:6px;font-size:12px;font-weight:600;letter-spacing:.6px;color:var(--muted);text-transform:uppercase">Im√°genes (opcional / arrastrar)
          <div id="dropZone" class="dropzone small" style="padding:18px 14px">
            <input type="file" multiple accept="image/*" id="pfImages" />
            <span class="dz-hint">Solt√° aqu√≠ o hac√© click para seleccionar</span>
            <small class="dz-count" style="display:block;margin-top:4px;color:var(--muted)">0 archivos</small>
            <div id="preview" class="dz-preview"></div>
          </div>
        </label>
      </div>
      <div class="inline-btns" style="margin-top:4px">
        <button class="btn-primary" type="submit" id="pfSubmit">Crear</button>
        <button class="btn-secondary" type="button" id="pfReset">Nuevo</button>
        <button class="btn-secondary" type="button" id="pfManageImages" style="display:none">Im√°genes‚Ä¶</button>
        <button class="btn-danger" type="button" id="pfDelete" style="display:none">Eliminar</button>
      </div>
      <div style="margin-top:10px">
          <div class="row between center" style="margin:0 0 6px">
          <div style="font-size:12px;color:var(--muted)">Im√°genes actuales</div>
          <button type="button" id="pfManageImagesAlt" class="btn-secondary" style="padding:6px 10px;font-size:12px">Gestionar‚Ä¶</button>
        </div>
        <div id="imgGallery" class="row wrap" style="gap:8px"></div>
        <div class="row" style="gap:8px;margin-top:8px">
          <button type="button" id="btnDelSelected" class="btn-danger" style="display:none">Eliminar seleccionadas</button>
          <span id="selCount" style="font-size:12px;color:var(--muted)"></span>
        </div>
      </div>
    </form>
    <!-- Modal gestor de im√°genes -->
    <div id="imgMgrOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9999;align-items:center;justify-content:center">
      <div style="background:#0b1520;border:1px solid #223140;border-radius:12px;width:min(760px,92vw);max-height:84vh;display:flex;flex-direction:column">
        <div class="row between center" style="padding:10px 12px;border-bottom:1px solid #223140">
          <h3 style="margin:0;font-size:16px">Im√°genes del producto</h3>
          <button id="imgMgrClose" class="icon-btn" aria-label="Cerrar">‚úï</button>
        </div>
        <div id="imgMgrBody" style="padding:12px;overflow:auto">
          <div id="imgMgrGrid" class="row wrap" style="gap:10px"></div>
          <div id="imgMgrEmpty" style="display:none;color:var(--muted);font-size:13px">Sin im√°genes.</div>
        </div>
        <div class="row between center" style="padding:10px 12px;border-top:1px solid #223140">
          <span id="imgMgrSelCount" style="font-size:12px;color:var(--muted)"></span>
          <div class="row" style="gap:8px">
            <button id="imgMgrDelSelected" class="btn-danger" style="display:none">Eliminar seleccionadas</button>
            <button id="imgMgrClose2" class="btn-secondary">Cerrar</button>
          </div>
        </div>
      </div>
    </div>
    <p style="margin:14px 0 0;font-size:11px;color:var(--muted);line-height:1.4">Flujo: completar datos y (opcional) elegir im√°genes. Al guardar, si es creaci√≥n primero se crea el producto y luego se suben las im√°genes seleccionadas. En edici√≥n pod√©s cambiar datos y agregar nuevas im√°genes (no reemplaza las existentes). Para remover im√°genes viejas usar futura gesti√≥n de galer√≠a.</p>
  </div>
  <div>
    <h2 style="margin:0 0 10px;font-size:18px">Listado ({{.Total}})</h2>
    <div class="row" style="margin:0 0 8px">
      <input type="text" id="prodSearch" placeholder="Buscar por nombre o slug..." aria-label="Buscar productos" style="width:260px;padding:8px 10px;border-radius:8px;border:1px solid #223140;background:#0b1520;color:#e5f0ff" />
    </div>
    <div style="overflow:auto">
      <table class="table" id="prodTable" style="font-size:0.8rem;min-width:880px">
        <thead><tr><th>Nombre</th><th>Slug</th><th>Precio</th><th>W</th><th>H</th><th>D</th><th>Stock</th><th>Imgs</th><th style="text-align:right">Acciones</th></tr></thead>
        <tbody>
          {{range .Products}}
          <tr data-slug="{{.Slug}}">
            <td>{{.Name}}</td>
            <td style="font-family:monospace">{{.Slug}}</td>
            <td>${{printf "%.2f" .BasePrice}}</td>
            <td>{{printf "%.0f" .WidthMM}}</td>
            <td>{{printf "%.0f" .HeightMM}}</td>
            <td>{{printf "%.0f" .DepthMM}}</td>
            <td>{{if .ReadyToShip}}‚úî{{else}}-{{end}}</td>
            <td>{{len .Images}}</td>
            <td style="text-align:right">
              <div class="table-actions">
                <button type="button" class="icon-btn action-images" data-act="images" title="Im√°genes">üñºÔ∏è</button>
                <button class="icon-btn action-edit" data-act="edit" title="Editar">‚úèÔ∏è</button>
                <button class="icon-btn danger action-del" data-act="del" title="Eliminar">üóëÔ∏è</button>
              </div>
            </td>
          </tr>
          {{end}}
        </tbody>
      </table>
      <div class="row" style="margin-top:10px;gap:8px">
        <button type="button" id="btnRepairImages" class="btn-secondary">Refresh images</button>
        <span id="repStatus" style="font-size:12px;color:var(--muted)"></span>
      </div>
    </div>
  </div>
</section>
{{template "layout_end" .}}
{{end}}
