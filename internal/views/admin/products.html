{{define "admin_products.html"}}
{{template "layout_start" .}}
<div class="admin-header">
  <h1>Gesti√≥n de Productos</h1>
  <nav class="admin-nav">
    <a href="/admin/products" class="active">Productos</a>
    <a href="/admin/orders">√ìrdenes</a>
    <a href="/admin/sales">Ventas</a>
    <a href="/admin/destacada">Destacada</a>
    <a href="/admin/costs">Calculadora</a>
    <a href="/admin/logout" class="admin-nav-logout">Salir</a>
  </nav>
</div>
<section class="admin-products-grid">
  <div class="admin-card admin-form-panel">
    <div class="row between center" style="margin-bottom:6px">
      <h2 style="margin:0;font-size:18px">Gesti√≥n de producto</h2>
      <span id="formMode" class="mode-badge create">Creaci√≥n</span>
    </div>
    <form id="prodForm" class="form-card" autocomplete="off" data-token="{{.AdminToken}}">
      <input type="hidden" name="slug" id="pfSlug" />
      <label>Nombre<input type="text" name="name" id="pfName" required placeholder="Nombre visible" /></label>
      <label>Categor√≠a<input type="text" name="category" id="pfCategory" placeholder="(opcional)" /></label>
      <label>Descripci√≥n corta<textarea name="short_desc" id="pfShort" placeholder="Resumen / marketing" rows="3"></textarea></label>
      <div class="admin-form-row">
        <label class="admin-form-col">Ancho (mm)<input type="number" step="0.1" min="0" id="pfWidth" placeholder="0" /></label>
        <label class="admin-form-col">Alto (mm)<input type="number" step="0.1" min="0" id="pfHeight" placeholder="0" /></label>
        <label class="admin-form-col">Prof. (mm)<input type="number" step="0.1" min="0" id="pfDepth" placeholder="0" /></label>
      </div>
      <label>Precio base<input type="number" step="0.01" min="0" name="base_price" id="pfPrice" required placeholder="0.00" /></label>
      <div class="admin-checkbox-label">
        <input type="checkbox" name="ready_to_ship" id="pfReady" />
        <span>Listo para env√≠o</span>
      </div>
      <label>Observaci√≥n<textarea name="observation" id="pfObservation" placeholder="Notas internas" rows="2"></textarea></label>
      <div class="admin-form-row">
        <label class="admin-form-col">Gramos<input type="number" step="0.01" min="0" id="pfGrams" placeholder="0" /></label>
        <label class="admin-form-col">Horas<input type="number" step="0.1" min="0" id="pfHours" placeholder="0" /></label>
      </div>
      <div class="admin-form-row">
        <label class="admin-form-col">P. Bruto<input type="number" step="0.01" min="0" id="pfGrossPrice" placeholder="0.00" /></label>
        <label class="admin-form-col">Ganancia<input type="number" step="0.01" min="0" id="pfProfit" placeholder="0.00" /></label>
      </div>
      <div class="uploader-block">
        <label style="display:flex;flex-direction:column;gap:6px;font-size:12px;font-weight:600;letter-spacing:.6px;color:var(--muted);text-transform:uppercase">Im√°genes (opcional / arrastrar)
          <div id="dropZone" class="dropzone small" style="padding:18px 14px">
            <input type="file" multiple accept="image/*" id="pfImages" />
            <span class="dz-hint">Solt√° aqu√≠ o hac√© click para seleccionar</span>
            <small class="dz-count" style="display:block;margin-top:4px;color:var(--muted)">0 archivos</small>
            <div id="preview" class="dz-preview"></div>
          </div>
        </label>
      </div>
      <div class="inline-btns" style="margin-top:4px">
        <button class="btn-primary" type="submit" id="pfSubmit">Crear</button>
        <button class="btn-secondary" type="button" id="pfReset">Nuevo</button>
        <button class="btn-secondary" type="button" id="pfManageImages" style="display:none">Im√°genes‚Ä¶</button>
        <button class="btn-danger" type="button" id="pfDelete" style="display:none">Eliminar</button>
      </div>
      <div style="margin-top:10px">
          <div class="row between center" style="margin:0 0 6px">
          <div style="font-size:12px;color:var(--muted)">Im√°genes actuales</div>
          <button type="button" id="pfManageImagesAlt" class="btn-secondary" style="padding:6px 10px;font-size:12px">Gestionar‚Ä¶</button>
        </div>
        <div id="imgGallery" class="row wrap" style="gap:8px"></div>
        <div class="row" style="gap:8px;margin-top:8px">
          <button type="button" id="btnDelSelected" class="btn-danger" style="display:none">Eliminar seleccionadas</button>
          <span id="selCount" style="font-size:12px;color:var(--muted)"></span>
        </div>
      </div>
    </form>
    <!-- Modal gestor de im√°genes -->
    <div id="imgMgrOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9999;align-items:center;justify-content:center">
      <div style="background:#0b1520;border:1px solid #223140;border-radius:12px;width:min(760px,92vw);max-height:84vh;display:flex;flex-direction:column">
        <div class="row between center" style="padding:10px 12px;border-bottom:1px solid #223140">
          <h3 style="margin:0;font-size:16px">Im√°genes del producto</h3>
          <button id="imgMgrClose" class="icon-btn" aria-label="Cerrar">‚úï</button>
        </div>
        <div id="imgMgrBody" style="padding:12px;overflow:auto">
          <div id="imgMgrGrid" class="row wrap" style="gap:10px"></div>
          <div id="imgMgrEmpty" style="display:none;color:var(--muted);font-size:13px">Sin im√°genes.</div>
        </div>
        <div class="row between center" style="padding:10px 12px;border-top:1px solid #223140">
          <span id="imgMgrSelCount" style="font-size:12px;color:var(--muted)"></span>
          <div class="row" style="gap:8px">
            <button id="imgMgrDelSelected" class="btn-danger" style="display:none">Eliminar seleccionadas</button>
            <button id="imgMgrClose2" class="btn-secondary">Cerrar</button>
          </div>
        </div>
      </div>
    </div>
    <p style="margin:14px 0 0;font-size:11px;color:var(--muted);line-height:1.4">Flujo: completar datos y (opcional) elegir im√°genes. Al guardar, si es creaci√≥n primero se crea el producto y luego se suben las im√°genes seleccionadas. En edici√≥n pod√©s cambiar datos y agregar nuevas im√°genes (no reemplaza las existentes). Para remover im√°genes viejas usar futura gesti√≥n de galer√≠a.</p>
  </div>
  <div>
    <h2 style="margin:0 0 10px;font-size:18px;display:flex;align-items:center;gap:8px">
      <span>Listado ({{.Total}})</span>
      <button type="button" id="btnClearFilters" class="btn-secondary" style="padding:4px 10px;font-size:11px;display:none">Limpiar filtros</button>
    </h2>
    <div class="row" style="margin:0 0 12px;gap:8px;flex-wrap:wrap">
      <input type="text" id="prodSearch" placeholder="Buscar por nombre o slug..." aria-label="Buscar productos" style="flex:1;min-width:200px;padding:10px 12px;border-radius:8px;border:1px solid #223140;background:#0b1520;color:#e5f0ff;font-size:14px" />
      <select id="categoryFilter" aria-label="Filtrar por categor√≠a" style="min-width:200px;padding:10px 12px;border-radius:8px;border:1px solid #223140;background:#0b1520;color:#e5f0ff;font-size:14px">
        <option value="">üîç Todas las categor√≠as</option>
        <option value="sin categor√≠a">‚ö†Ô∏è Sin categor√≠a</option>
        {{range .Categories}}
          <option value="{{.}}">{{.}}</option>
        {{end}}
      </select>
    </div>
    <div class="admin-table-wrapper">
      <table class="table admin-products-table" id="prodTable">
        <thead>
          <tr>
            <th>Nombre</th>
            <th class="hide-mobile">Slug</th>
            <th>Precio</th>
            <th>Categor√≠a</th>
            <th class="hide-mobile">W</th>
            <th class="hide-mobile">H</th>
            <th class="hide-mobile">D</th>
            <th class="hide-small">Stock</th>
            <th class="hide-mobile">Gramos</th>
            <th class="hide-mobile">Horas</th>
            <th class="hide-mobile">P. Bruto</th>
            <th class="hide-mobile">Ganancia</th>
            <th class="hide-small">Imgs</th>
            <th style="text-align:right">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {{range .Products}}
          <tr data-slug="{{.Slug}}" data-category="{{.Category}}" class="admin-product-row">
            <td class="admin-product-name">
              <div style="font-weight:600">{{.Name}}</div>
              <div class="show-mobile" style="font-size:11px;color:var(--muted);margin-top:2px">{{if .Category}}{{.Category}}{{else}}<span style="color:#f59e0b">Sin categor√≠a</span>{{end}}</div>
            </td>
            <td class="hide-mobile" style="font-family:monospace;font-size:12px">{{.Slug}}</td>
            <td style="font-weight:600">${{formatPrice .BasePrice}}</td>
            <td class="hide-mobile">{{if .Category}}{{.Category}}{{else}}<span style="color:#f59e0b;font-size:12px">Sin cat.</span>{{end}}</td>
            <td class="hide-mobile">{{printf "%.0f" .WidthMM}}</td>
            <td class="hide-mobile">{{printf "%.0f" .HeightMM}}</td>
            <td class="hide-mobile">{{printf "%.0f" .DepthMM}}</td>
            <td class="hide-small">{{if .ReadyToShip}}<span style="color:#10b981">‚úî</span>{{else}}<span style="color:var(--muted)">-</span>{{end}}</td>
            <td class="hide-mobile">{{printf "%.0f" .Grams}}</td>
            <td class="hide-mobile">{{printf "%.1f" .Hours}}</td>
            <td class="hide-mobile">${{formatPrice .GrossPrice}}</td>
            <td class="hide-mobile">${{formatPrice .Profit}}</td>
            <td class="hide-small">{{if gt (len .Images) 0}}<span style="color:#10b981">{{len .Images}}</span>{{else}}<span style="color:#ef4444">0</span>{{end}}</td>
            <td style="text-align:right">
              <div class="table-actions">
                <button type="button" class="icon-btn action-images" data-act="images" title="Im√°genes">üñºÔ∏è</button>
                <button class="icon-btn action-edit" data-act="edit" title="Editar">‚úèÔ∏è</button>
                <button class="icon-btn danger action-del" data-act="del" title="Eliminar">üóëÔ∏è</button>
              </div>
            </td>
          </tr>
          {{end}}
        </tbody>
      </table>
      <div class="row" style="margin-top:10px;gap:8px">
        <button type="button" id="btnRepairImages" class="btn-secondary">Refresh images</button>
        <span id="repStatus" style="font-size:12px;color:var(--muted)"></span>
      </div>
    </div>
  </div>
</section>
{{template "layout_end" .}}
{{end}}
