{{define "products.html"}}
{{template "layout_start" .}}
<h1 class="section-title">Productos</h1>
<p class="result-count">{{len .Products}} resultados{{if .Query}} para “{{.Query}}”{{end}}</p>
<h2 class="sr-only">Filtros</h2>
<div class="mobile-actions">
  <button class="btn-filter" aria-expanded="false" aria-controls="filterDrawer">Filtrar</button>
  <button class="btn-sort" aria-expanded="false" aria-controls="sortSheet">Ordenar</button>
  <noscript><style>.filters-row{display:block!important}</style></noscript>
</div>

<aside id="filterDrawer" class="drawer" hidden aria-hidden="true">
  <form id="filtersForm" class="filters" method="get" action="/products">
    <header class="drawer-head">
      <h2>Filtrar</h2>
      <button type="button" class="drawer-close" aria-label="Cerrar">×</button>
    </header>

    <div class="drawer-body">
      <div class="field">
        <label for="q">Buscar por nombre</label>
        <input id="q" type="text" name="q" value="{{.Query}}" placeholder="Buscar..." />
      </div>
      <div class="field">
        <label for="category">Categoría</label>
        <select id="category" name="category">
          <option value="">Todas las categorías</option>
          {{range .Categories}}
            <option value="{{.}}" {{if eq $.Category .}}selected{{end}}>{{.}}</option>
          {{end}}
        </select>
      </div>

      <input type="hidden" id="sortInput" name="sort" value="{{.Sort}}">
    </div>

    <footer class="drawer-foot">
      <button type="submit" class="btn-primary">Aplicar</button>
      <a class="link-reset" href="/products">Limpiar</a>
    </footer>
  </form>
</aside>

<div id="sortSheet" class="sheet" hidden aria-hidden="true">
  <header class="sheet-head">
    <h2>Ordenar</h2>
    <button type="button" class="sheet-close" aria-label="Cerrar">×</button>
  </header>
  <ul class="sort-list">
    <li><button type="button" data-sort="newest" aria-pressed="{{eq .Sort "newest"}}">Novedades</button></li>
    <li><button type="button" data-sort="price_asc" aria-pressed="{{eq .Sort "price_asc"}}">Precio: menor a mayor</button></li>
    <li><button type="button" data-sort="price_desc" aria-pressed="{{eq .Sort "price_desc"}}">Precio: mayor a menor</button></li>
    <li><button type="button" data-sort="name" aria-pressed="{{eq .Sort "name"}}">Nombre A–Z</button></li>
  </ul>
</div>

<div class="cards cards--products">
  {{range $idx, $p := .Products}}
  <div class="card">
    <div class="card-media ar-1-1">
      {{if $p.Images}}
        <img src="{{img (index $p.Images 0).URL}}"
             alt="{{if (index $p.Images 0).Alt}}{{(index $p.Images 0).Alt}}{{else}}{{$p.Name}}{{end}}"
             loading="lazy" decoding="async" {{if eq $idx 0}}fetchpriority="high"{{end}}
             srcset="{{img (index $p.Images 0).URL}} 300w, {{imgw (index $p.Images 0).URL 480}} 480w, {{imgw (index $p.Images 0).URL 640}} 640w"
             sizes="(max-width:480px) 92vw, (max-width:768px) 44vw, 300px"
             class="card-img" />
      {{else}}
        <div class="placeholder">IMG</div>
      {{end}}
    </div>
    <div class="card-body">
      <h3 class="card-title"><a href="/product/{{$p.Slug}}">{{$p.Name}}</a></h3>
      <div class="card-meta">{{$p.Category}}</div>
      <div class="price-row"><span class="price">${{printf "%.0f" $p.BasePrice}}</span></div>
      <div class="actions">
        <a href="/product/{{$p.Slug}}" class="btn-secondary btn-full">Ver detalles ›</a>
      </div>
    </div>
  </div>
  {{end}}
  {{if not .Products}}
    <p class="empty">No se encontraron productos.</p>
  {{end}}
</div>

<div style="text-align:center;margin:12px 0">
  <button id="loadMore" class="btn-secondary" data-next="{{if lt .Page .Pages}}?page={{add .Page 1}}&q={{.Query}}&category={{.Category}}&sort={{.Sort}}{{end}}" {{if not (lt .Page .Pages)}}disabled{{end}}>Cargar más</button>
  <div id="loadMoreStatus" class="sr-only" aria-live="polite"></div>
</div>

{{if and .Page .Pages}}
<div class="pagination">
  {{if gt .Page 1}}<a href="?page={{sub .Page 1}}&q={{.Query}}&category={{.Category}}&sort={{.Sort}}" class="page-btn">‹ Anterior</a>{{end}}
  <span>Página {{.Page}} / {{.Pages}}</span>
  {{if lt .Page .Pages}}<a href="?page={{add .Page 1}}&q={{.Query}}&category={{.Category}}&sort={{.Sort}}" class="page-btn">Siguiente ›</a>{{end}}
</div>
{{end}}

<script>
(function(){
  const $ = s => document.querySelector(s);
  const filterBtn = $('.btn-filter');
  const sortBtn   = $('.btn-sort');
  const drawer    = $('#filterDrawer');
  const sheet     = $('#sortSheet');
  const closeD    = drawer?.querySelector('.drawer-close');
  const closeS    = sheet?.querySelector('.sheet-close');
  const form      = $('#filtersForm');
  const sortInput = $('#sortInput');

  function open(el, btn){ el.hidden=false; el.setAttribute('aria-hidden','false'); btn?.setAttribute('aria-expanded','true'); document.body.style.overflow='hidden'; }
  function close(el, btn){ el.hidden=true;  el.setAttribute('aria-hidden','true');  btn?.setAttribute('aria-expanded','false'); document.body.style.overflow=''; }

  filterBtn?.addEventListener('click', ()=> open(drawer, filterBtn));
  closeD?.addEventListener('click',   ()=> close(drawer, filterBtn));
  sortBtn?.addEventListener('click',  ()=> open(sheet, sortBtn));
  closeS?.addEventListener('click',   ()=> close(sheet, sortBtn));

  drawer?.addEventListener('click', e => { if(e.target===drawer) close(drawer, filterBtn); });
  sheet?.addEventListener('click',  e => { if(e.target===sheet)  close(sheet,  sortBtn); });

  sheet?.querySelectorAll('[data-sort]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(!sortInput || !form) return;
      sortInput.value = btn.dataset.sort;
      form.submit();
    });
  });

  document.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){
      if(!drawer?.hidden) close(drawer, filterBtn);
      if(!sheet?.hidden)  close(sheet,  sortBtn);
    }
  });
})();
</script>
<script>
(function(){
  const $ = s => document.querySelector(s);
  const filterBtn = $('.btn-filter');
  const sortBtn   = $('.btn-sort');
  const drawer    = $('#filterDrawer');
  const sheet     = $('#sortSheet');
  const closeD    = drawer?.querySelector('.drawer-close');
  const closeS    = sheet?.querySelector('.sheet-close');
  const form      = $('#filtersForm');
  const sortInput = $('#sortInput');

  function open(el, btn){ el.hidden=false; el.setAttribute('aria-hidden','false'); btn?.setAttribute('aria-expanded','true'); document.body.style.overflow='hidden'; }
  function close(el, btn){ el.hidden=true;  el.setAttribute('aria-hidden','true');  btn?.setAttribute('aria-expanded','false'); document.body.style.overflow=''; }

  filterBtn?.addEventListener('click', ()=> open(drawer, filterBtn));
  closeD?.addEventListener('click',   ()=> close(drawer, filterBtn));
  sortBtn?.addEventListener('click',  ()=> open(sheet, sortBtn));
  closeS?.addEventListener('click',   ()=> close(sheet, sortBtn));

  drawer?.addEventListener('click', e => { if(e.target===drawer) close(drawer, filterBtn); });
  sheet?.addEventListener('click',  e => { if(e.target===sheet)  close(sheet,  sortBtn); });

  sheet?.querySelectorAll('[data-sort]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(!sortInput || !form) return;
      sortInput.value = btn.dataset.sort;
      form.submit();
    });
  });

  document.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){
      if(!drawer?.hidden) close(drawer, filterBtn);
      if(!sheet?.hidden)  close(sheet,  sortBtn);
    }
  });
})();
</script>
<!-- JS movido a /public/assets/app.js -->
{{template "layout_end" .}}
{{end}}
